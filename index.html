<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Graf Buffer Archive · Project D (MVP)</title>
  <meta name="description" content="Внешнее буферное хранилище для архивов чатов и глав книги. Однофайловый MVP: индекс + поиск + теги + постоянные ссылки."/>
  <style>
    :root{--bg:#0b0e11;--panel:#12161b;--muted:#8da0b3;--text:#e8edf4;--accent:#4cc9f0;--accent2:#a8dadc;--border:#1c222b;--good:#7bd88f}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:auto 1fr;gap:0;height:100%}
    header{grid-column:1/3;display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    header .actions{display:flex;gap:10px;flex-wrap:wrap}
    button, .btn{background:#17202a;color:var(--text);border:1px solid var(--border);padding:12px 16px;border-radius:12px;cursor:pointer;font-size:16px}
    button:hover,.btn:hover{border-color:#2a3747}
    button.primary{background:linear-gradient(180deg,#1b2633,#111720);border-color:#243042}
    .ok{color:var(--good)}
    aside{border-right:1px solid var(--border);background:var(--panel);padding:14px 12px;overflow:auto}
    .sectionTitle{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;margin:14px 6px}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav a{padding:12px 12px;border-radius:12px;color:var(--text);text-decoration:none;border:1px solid transparent;font-size:16px}
    .nav a.active{background:#10161f;border-color:#1d2530}
    .search{display:flex;gap:10px;padding:10px}
    .search input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0e141c;color:var(--text);font-size:16px}
    .tags{display:flex;flex-wrap:wrap;gap:8px;padding:0 10px 10px}
    .tag{font-size:13px;padding:6px 10px;border-radius:16px;border:1px solid var(--border);cursor:pointer;color:var(--muted)}
    .tag.active{border-color:#2b394c;color:var(--accent)}
    main{overflow:auto;padding:16px 18px}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .card{border:1px solid var(--border);background:#0f141b;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0;font-size:18px}
    .card .meta{font-size:13px;color:var(--muted)}
    .card .tags{padding:0}
    .detail{max-width:920px;margin:0 auto;display:none}
    .detail.active{display:block}
    .muted{color:var(--muted)}
    .empty{opacity:.7;border:1px dashed var(--border);border-radius:12px;padding:18px;text-align:center}
    .split{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .panel{border:1px solid var(--border);border-radius:12px;background:#0f141b}
    .panel h4{margin:0;padding:12px;border-bottom:1px solid var(--border);font-size:14px;color:var(--muted)}
    .panel .inner{padding:12px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c1117;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .footer{font-size:12px;color:var(--muted);padding:8px 12px;border-top:1px solid var(--border)}
    .pill{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .danger{color:#ffadad}
    .link{color:var(--accent)}
    .hidden{display:none}
    textarea, input[type="text"], select{width:100%;background:#0e141c;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    /* Крупные кликабельные зоны для планшета */
    .btn, button, .nav a{min-height:44px;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Graf Buffer Archive <span class="pill">MVP</span></h1>
      <div class="actions">
        <label class="btn">Импорт JSON<input id="importJson" type="file" accept="application/json" hidden/></label>
        <button id="exportJson">Экспорт JSON</button>
        <button id="newEntry" class="primary">Новая запись</button>
      </div>
    </header>

    <aside>
      <div class="section">
        <div class="sectionTitle">Разделы</div>
        <nav class="nav" id="nav">
          <a href="#archive" class="active">Архив чатов</a>
          <a href="#book">Главы книги</a>
          <a href="#about">О буфере</a>
        </nav>
      </div>
      <div class="section">
        <div class="sectionTitle">Фильтр</div>
        <div class="search"><input id="q" placeholder="Поиск по тексту…"/></div>
        <div id="tagBar" class="tags"></div>
      </div>
      <div class="footer">Однофайловый режим. Данные ниже в <span class="kbd">#seed</span>. Можно импортировать/экспортировать <span class="kbd">archive.json</span>.</div>
    </aside>

    <main>
      <section id="view-list" class="view">
        <div class="list" id="cards"></div>
        <div id="empty" class="empty hidden">Нет данных. Создайте запись (кнопка «Новая запись») или импортируйте <span class="kbd">archive.json</span>.</div>
      </section>

      <section id="view-detail" class="view detail"></section>

      <section id="view-about" class="view detail">
        <h2>О буферном архиве</h2>
        <p class="muted">Это внешний «жёсткий диск» для наших чатов и глав книги. Работает как статическая страница: достаточно разместить этот файл <span class="kbd">index.html</span> на любом хостинге (или открыть локально). Контент хранится во встроенном JSON (#seed) или в отдельном <span class="kbd">archive.json</span>.</p>
        <ul>
          <li>Полнотекстовый поиск (к полям: заголовок, описание, содержимое).</li>
          <li>Фильтр по тегам и разделам («Архив чатов», «Главы книги»).</li>
          <li>Постоянные ссылки вида <span class="kbd">#item/&lt;id&gt;</span>.</li>
          <li>Импорт/экспорт JSON для резервного копирования.</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- Карточка списка -->
  <template id="cardTmpl">
    <article class="card">
      <div class="meta"></div>
      <h3></h3>
      <div class="excerpt muted"></div>
      <div class="tags"></div>
      <div class="row">
        <a class="btn" data-open>Открыть</a>
        <a class="btn" data-copy>Копировать ссылку</a>
      </div>
    </article>
  </template>

  <!-- Страница записи -->
  <template id="detailTmpl">
    <article>
      <a class="btn" href="#">← Назад</a>
      <h2></h2>
      <div class="meta"></div>
      <div class="tags"></div>
      <hr style="border-color:var(--border)">
      <div class="content"></div>
    </article>
  </template>

  <!-- Диалог создания записи -->
  <dialog id="dlg">
    <form method="dialog" class="panel" style="max-width:860px;width:96vw">
      <h4 style="margin:0;padding:12px;border-bottom:1px solid var(--border);color:var(--muted)">Новая запись</h4>
      <div class="inner">
        <div class="row">
          <div style="flex:2"><label>Заголовок<input id="f_title" type="text" required></label></div>
          <div style="flex:1"><label>Дата<input id="f_date" type="text" placeholder="2025-08-11"></label></div>
        </div>
        <div class="row">
          <div style="flex:1"><label>Раздел<select id="f_section"><option value="archive">Архив чатов</option><option value="book">Главы книги</option></select></label></div>
          <div style="flex:2"><label>Теги (через запятую)<input id="f_tags" type="text" placeholder="RESEEK, признания, спина"></label></div>
        </div>
        <label>Краткое описание<textarea id="f_excerpt" rows="2"></textarea></label>
        <label>Содержимое (Markdown/HTML)<textarea id="f_content" rows="10"></textarea></label>
        <div class="row" style="justify-content:flex-end"><button class="btn" value="cancel">Отмена</button><button class="btn primary" id="save">Сохранить</button></div>
      </div>
    </form>
  </dialog>

  <!-- Встроенный JSON-сид (можно убрать и использовать внешний archive.json) -->
  <script id="seed" type="application/json">
  {
    "items": [
      {
        "id": "demo-1",
        "title": "Архивариус (черновая статья)",
        "date": "2025-08-10",
        "section": "archive",
        "tags": ["архив", "буфер", "веб"],
        "excerpt": "Зачем нам внешний буфер и как он спасает от сбросов памяти GPT.",
        "content": "<p><strong>Идея:</strong> внешний сайт как долговременная память. Фиксируем ключевые узлы беседы, схемы и глоссарий. Любой сброс чата не страшен.</p><ul><li>Раздел 1: Архив чатов</li><li>Раздел 2: Главы книги</li></ul>"
      },
      {
        "id": "demo-2",
        "title": "RESEEK · тезисы",
        "date": "2025-08-11",
        "section": "book",
        "tags": ["RESEEK", "теория", "эволюция"],
        "excerpt": "Repatterning → Emergence → Split → Evolution → Exclusion → Kingdom.",
        "content": "<p>Краткая экспликация шести фаз. Визуальные коды и топология отбора.</p>"
      }
    ]
  }
  </script>

  <script>
    // === Мини‑движок ===
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    const state = { items:[], tags:new Set(), section:'archive', q:'', tagFilter:new Set() };

    // Загрузка из встроенного сидa + попытка подхватить внешний archive.json
    async function boot(){
      try{
        const embedded = JSON.parse($('#seed')?.textContent || '{"items":[]}');
        state.items = normalize(embedded.items||[]);
      }catch(e){ state.items = []; }
      // если рядом лежит archive.json — подтянем и сольём
      try{
        const res = await fetch('archive.json', {cache:'no-store'});
        if(res.ok){
          const extra = await res.json();
          state.items = normalize([...(state.items||[]), ...((extra.items)||[])]);
        }
      }catch(e){}
      collectTags();
      bindUI();
      route();
    }

    function normalize(items){
      return (items||[]).map((it,i)=>({
        id: it.id || (Date.now()+"-"+i),
        title: it.title||"Без названия",
        date: it.date||new Date().toISOString().slice(0,10),
        section: it.section||'archive',
        tags: (it.tags||[]).map(t=>String(t).trim()).filter(Boolean),
        excerpt: it.excerpt||'',
        content: it.content||''
      }));
    }

    function collectTags(){
      state.tags = new Set();
      state.items.forEach(it => (it.tags||[]).forEach(t=>state.tags.add(t)));
      const bar = $('#tagBar');
      bar.innerHTML = '';
      [...state.tags].sort().forEach(t=>{
        const a = document.createElement('button');
        a.type='button'; a.className='tag'; a.textContent = t;
        a.onclick = () => { toggleTag(t); };
        bar.appendChild(a);
      });
    }

    function toggleTag(t){
      if(state.tagFilter.has(t)) state.tagFilter.delete(t); else state.tagFilter.add(t);
      render();
    }

    function bindUI(){
      $('#nav').addEventListener('click', (e)=>{
        const a = e.target.closest('a'); if(!a) return;
        e.preventDefault();
        location.hash = a.getAttribute('href');
      });
      $('#q').addEventListener('input', (e)=>{ state.q = e.target.value.toLowerCase(); render(); });
      $('#newEntry').onclick = openDialog;
      $('#exportJson').onclick = exportJson;
      $('#importJson').onchange = importJson;
      window.addEventListener('hashchange', route);
    }

    function route(){
      const h = location.hash || '#archive';
      const [root, id] = h.replace('#','').split('/');
      $$('#nav a').forEach(a=>a.classList.toggle('active', a.getAttribute('href') === '#'+root));
      state.section = (root==='book'||root==='archive') ? root : state.section;
      $$('#view-list, #view-detail, #view-about').forEach(v=>v.classList.remove('active'));
      if(root==='item' && id){ openItem(id); }
      else if(root==='about'){ $('#view-detail').classList.remove('active'); $('#view-about').classList.add('active'); render(); }
      else { $('#view-about').classList.remove('active'); $('#view-detail').classList.remove('active'); $('#view-list').classList.add('active'); render(); }
    }

    function render(){
      const listEl = $('#cards');
      const empty = $('#empty');
      const q = state.q;
      const sec = state.section;
      const tagSet = state.tagFilter;
      const items = state.items.filter(it=>
        it.section===sec &&
        (!q || (it.title+it.excerpt+it.content).toLowerCase().includes(q)) &&
        (tagSet.size===0 || it.tags.some(t=>tagSet.has(t)))
      ).sort((a,b)=> (a.date<b.date?1:-1));
      listEl.innerHTML = '';
      empty.classList.toggle('hidden', items.length>0);
      items.forEach(it=> listEl.appendChild(card(it)) );
      // подсветка активных тегов
      $$('#tagBar .tag').forEach(btn=>{
        const t = btn.textContent; btn.classList.toggle('active', state.tagFilter.has(t));
      });
    }

    function card(it){
      const tpl = $('#cardTmpl').content.cloneNode(true);
      tpl.querySelector('h3').textContent = it.title;
      tpl.querySelector('.meta').textContent = `${it.date} · ${it.section==='archive'?'Архив чатов':'Главы книги'}`;
      tpl.querySelector('.excerpt').innerHTML = it.excerpt||'';
      const tags = tpl.querySelector('.tags');
      (it.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; s.onclick=()=>toggleTag(t); tags.appendChild(s); });
      tpl.querySelector('[data-open]').onclick = ()=>{ location.hash = `#item/${it.id}`; };
      tpl.querySelector('[data-copy]').onclick = ()=>{ navigator.clipboard.writeText(location.origin+location.pathname+`#item/${it.id}`); };
      return tpl;
    }

    function openItem(id){
      const it = state.items.find(x=>x.id===id);
      const view = $('#view-detail');
      if(!it){ location.hash = '#'+state.section; return; }
      const t = $('#detailTmpl').content.cloneNode(true);
      t.querySelector('h2').textContent = it.title;
      t.querySelector('.meta').textContent = `${it.date} · ${it.section==='archive'?'Архив чатов':'Главы книги'}`;
      const tags = t.querySelector('.tags');
      (it.tags||[]).forEach(x=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=x; tags.appendChild(s); });
      t.querySelector('.content').innerHTML = it.content;
      $$('#view-list, #view-about').forEach(v=>v.classList.remove('active'));
      view.innerHTML=''; view.appendChild(t); view.classList.add('active');
    }

    function openDialog(){
      const dlg = $('#dlg');
      dlg.showModal();
      $('#save').onclick = (e)=>{
        e.preventDefault();
        const it = {
          id: 'id-'+Math.random().toString(36).slice(2,10),
          title: $('#f_title').value.trim(),
          date: $('#f_date').value.trim()||new Date().toISOString().slice(0,10),
          section: $('#f_section').value,
          tags: $('#f_tags').value.split(',').map(s=>s.trim()).filter(Boolean),
          excerpt: $('#f_excerpt').value,
          content: ($('#f_content').value||'').replace(/\n/g,'\n')
        };
        state.items.unshift(it);
        collectTags(); render(); dlg.close();
      };
    }

    function exportJson(){
      const data = { items: state.items };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'archive.json'; a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJson(e){
      const file = e.target.files?.[0]; if(!file) return;
      const rd = new FileReader();
      rd.onload = () => {
        try{
          const data = JSON.parse(rd.result);
          state.items = normalize([...(state.items||[]), ...((data.items)||[])]);
          collectTags(); render();
        }catch(err){ alert('Не удалось прочитать JSON'); }
      };
      rd.readAsText(file);
    }

    boot();
  </script>
</body>
</html>

